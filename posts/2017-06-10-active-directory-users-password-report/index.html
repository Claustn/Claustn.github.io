<!doctype html><html lang=en><head><title>Active Directory Users Password Report :: XenoBlog — Random rants</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="I was working with a customer; all their admin users had at least three accounts, a regular account, a domain admin account and a &amp;ldquo;server admin&amp;rdquo; account, some even had a &amp;ldquo;client admin&amp;rdquo; account as well per domain.
In a discussion with security, they told me that now, everything was good, and they were more secure. I told them that in theory, they were more secure, but what if their admins just used the same password for all their accounts."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/posts/2017-06-10-active-directory-users-password-report/><link rel=stylesheet href=/assets/style.css><link rel=stylesheet href=/assets/green.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/img/favicon/green.png><meta name=twitter:card content="summary"><meta name=twitter:site content><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Active Directory Users Password Report :: XenoBlog"><meta property="og:description" content="I was working with a customer; all their admin users had at least three accounts, a regular account, a domain admin account and a &amp;ldquo;server admin&amp;rdquo; account, some even had a &amp;ldquo;client admin&amp;rdquo; account as well per domain.
In a discussion with security, they told me that now, everything was good, and they were more secure. I told them that in theory, they were more secure, but what if their admins just used the same password for all their accounts."><meta property="og:url" content="/posts/2017-06-10-active-directory-users-password-report/"><meta property="og:site_name" content="Active Directory Users Password Report"><meta property="og:image" content="/img/favicon/green.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:section" content="Everyday"><meta property="article:published_time" content="2017-06-10 09:02:28 +0000 UTC"></head><body><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>XenoBlog</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=https://github.com/claustn>github</a></li><li><a href=/index.xml>RSS</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=https://github.com/claustn>github</a></li><li><a href=/index.xml>RSS</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=/posts/2017-06-10-active-directory-users-password-report/>Active Directory Users Password Report</a></h1><div class=post-meta><span class=post-date>2017-06-10</span></div><div class=post-content><div><p>I was working with a customer; all their admin users had at least three accounts, a regular account, a domain admin account and a &ldquo;server admin&rdquo; account, some even had a &ldquo;client admin&rdquo; account as well per domain.</p><p>In a discussion with security, they told me that now, everything was good, and they were more secure. I told them that in theory, they were more secure, but what if their admins just used the same password for all their accounts.</p><p>They did not think that, that was a real problem, and that none of their admins would reuse their passwords across their different accounts.</p><p>I had a sneaking suspicion that that was not the case, so I decided to test it out, which required a little ingenuity.</p><p>So I sat down and wrote a list of things that I would like to get from AD. ( I was specifically told not to use any &ldquo;brute force&rdquo; methods to guess their user&rsquo;s passwords, but I was allowed to compile a list of &ldquo;improbable&rdquo; used passwords like summer2017, Fall2017 etc. that security was sure no one would use ;) )</p><p><strong>• All current users with the same password<br>• Currently Most used Hash/Password statistics<br>• Most Used Hash Historically<br>• Users with &ldquo;weak&rdquo; password (Based on list of known passwords)<br>• User who have never changed password<br>• Users with a blank password<br>• Users who have had a blank password<br>• Users who have reused a password</strong></p><p>If I could get that data out of AD, I would be able to give the security team an idea about the current status of their &ldquo;users.&rdquo;</p><p><strong>Just to get one thing straight, by running the below scripts you are probably violating every security guideline in your company, do not play around with this, unless you understand what you are doing, and have written consent from your company. Also in the below examples, I am not adhering to &ldquo;good&rdquo; security practice by revealing the passwords of users (In my example it is only test data), again this was done to prove a point about insecure passwords. Last but NOT least, you have just copied ALL the keys to the kingdom from AD to unprotected files, I cannot stress this enough, you have to protect everything you export from AD!!!</strong></p><p>I had previously helped Danish Security researcher Jakob H Heidelberg in regards to a PowerShell script using <a href=http://dsinternals.com>DSinternals</a> from Michael Grafnetter he had written to do something similar, so I knew it was possible to get this from AD, but I wanted to create a solution that would scale, and be able to create a report that was easily searchable.<br>You can find Jakob&rsquo;s original script <a href=https://github.com/ZilentJack/Get-bADpasswords>here</a></p><p>As you probably know, by default you cannot get AD to reveal a users Password hash, you need some way to extract that from the AD database, I am not going to go into details about that here, and in the below example I will use DSInternals functionality to &ldquo;pretend&rdquo; to be a domain controller, and that way get a real domain controller to sync over all its information. There are other ways to obtain the same information, but that is out of scope for this blog post.</p><p>The first thing I did was to compile a short list of very easily guessable passwords, and simple permutations thereof, again we are talking Summer2016, Winter2017, CompanyName01 etc. etc.</p><p>In the sample data, I am using for this blog post, I created an AD and created 500 accounts using a modified version of Helge Kleins tool here: <a href=https://helgeklein.com/blog/2015/02/creating-realistic-test-user-accounts-active-directory/>https://helgeklein.com/blog/2015/02/creating-realistic-test-user-accounts-active-directory/</a> This way of using &ldquo;real names&rdquo; the users are more easily told apart than if I had just created random strings.</p><p><a href=http://www.xipher.dk/WordPress/wp-content/uploads/mstsc_2017-06-11_22-51-08.png><img src=/assets/images/mstsc_2017-06-11_22-51-08-1024x695.png alt></a></p><p>(/assets/images/mstsc_2017-06-11_22-51-08-1024x695.png)](<a href=http://www.xipher.dk/WordPress/wp-content/uploads/mstsc_2017-06-11_22-51-08.png>http://www.xipher.dk/WordPress/wp-content/uploads/mstsc_2017-06-11_22-51-08.png</a>)</p><p>After creating the users I randomly assigned them as a password from a list of known passwords, I created a list of passwords MuchoSecuros1 through MuchoSecuros2000, I assigned these password to users at random, I did this just to make sure I had users with the same password. Again this was chosen for easy recognition of the results.</p><p>Then I needed a way to query the data that I pulled from AD, and here I ended up choosing SQLite, for those of you that do not know it, SQLite is a small database engine, that does not require any installation, and can be run just using an SQLite DLL file. Here I am using Warren &ldquo;RamblingCookieMonster&rdquo; Frames SQLite PowerShell module, which includes the DLL files and code to manipulate it.</p><p>In the database I created three tables:<br>• HashHistory (Containing all users Hash History, in this example AD stores the last 20 password hashes a user have used)<br>• PWDTranslation (All the &ldquo;known&rdquo; passwords and their generated hash value)<br>• Users (All the user&rsquo;s data)</p><p><a href=http://www.xipher.dk/WordPress/wp-content/uploads/DB-Overview.png><img src=/assets/images/DB-Overview.png alt></a></p><p>By putting it in a database like this, I made it very easy (fast) to query, and as an added benefit I could add data to this over time, to store more than the 20 last password hashes.</p><p>Let&rsquo;s get down to business!</p><p>First off, the script is not 100% self-contained it requires some external modules as well (It is, of course, easy to create a package, that contains all the modules, and copy them to an offline machine)</p><p>Required PowerShell modules:</p><p>• PSSQLite<br>• EnhancedHTML2<br>• Dsinternals</p><p>Currently, the &ldquo;main&rdquo; script is split into three files.</p><p>• Setup.ps1 (Setup the SQLite database)<br>• LoadDataIntoSQL.ps1 (Loads data into SQLite)<br>• ReportGenerator.ps1 (Takes data from DB and creates HTML report)</p><p>In all of the three above files, there is a reference to the SQLite Database file, that has to be changed to reflect where you want to store the DB file.</p><p>In LoadDataIntoSQL.ps1 there is also a variable called $Passwords this gets populated with a list of &ldquo;known&rdquo; passwords, in the script, this just refers to a file with a single password on each line, each password will get converted into a hash and stored in the DB.</p><p>It is also from this file that Get-ADReplAccount is called, which is the cmdlet that syncs with a domain controller, so if you do not have permissions to do that, it will fail.</p><p>ReportGenerator has a variable called $ReportPath, which is where the report will be stored.</p><p>One thing to note is that the Report loads a client side javascript to do the formatting, only Internet Explorer allows you to do that.</p><p>Javascripts are located here:<br>&lsquo;<a href="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.3/jquery.dataTables.min.js'">http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.3/jquery.dataTables.min.js'</a><br>&lsquo;<a href="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.8.2.min.js'">http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.8.2.min.js'</a></p><p>To get more detailed data I also wrote a small snippet of code, to change the password for each user the same amount of times that is configured in AD, I did this to show how password history is used in the script.</p><p>First I generate a list of 2000 passwords, and load them into a variable:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>1..2000 | % { <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>MuchoSecuros</span><span style=color:#e6db74>$</span><span style=color:#e6db74>\_</span><span style=color:#e6db74>&#34;</span> | Out-file C:\temp\PasswordChange\Passwords.txt -Append } $Passwords = Get-Content C:\temp\PasswordChange\Passwords.txt
</code></pre></div><p>Then I use ADSI to get information about the domain:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>$ADDomain = <span style=color:#66d9ef>[ADSI]</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>WinNT://</span><span style=color:#e6db74>$</span><span style=color:#e6db74>env:userdomain</span><span style=color:#e6db74>&#34;</span>
</code></pre></div><p>Then I use this information to figure out, what the password history is on the domain and change the password for each account that amount of times</p><pre><code>Measure-Command -Expression { 1..$($ADDomain.PasswordHistoryLength) | % { Get-ADUser -Filter \* -SearchScope Subtree -SearchBase &quot;OU=TestUsers,DC=pwdtest,DC=test&quot; | % { Set-ADAccountPassword -Identity $\_.DistinguishedName -Reset -NewPassword (ConvertTo-SecureString -AsPlainText $($Passwords | Get-Random) -Force) } } }
</code></pre><p>Here is a video showing the scripts in action. (Be gentle this is my first attempt at creating a video)<br>[video width="1920&rdquo; height="1080&rdquo; mp4="http://www.xipher.dk/WordPress/wp-content/uploads/Password-report.mp4&rdquo;][/video]</p><p>Link to the files on Github <a href=https://github.com/Claustn/Password-Report>https://github.com/Claustn/Password-Report</a></p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=/posts/2018-09-23-loading-p0wned-password-files-into-sqlite/><span class=button__icon>←</span>
<span class=button__text>Loading "P0wned" password file into SQLite</span></a></span>
<span class="button next"><a href=/posts/2017-05-14-monitoring-your-vms-using-screenshots/><span class=button__text>Monitoring your VM's using screenshots</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2020 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=/assets/main.js></script><script src=/assets/prism.js></script></div></body></html>