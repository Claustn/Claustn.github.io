<!doctype html><html lang=en><head><title>My account keeps getting locked out, where did I use it ?? :: XenoBlog — Random rants</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="A few weeks ago my admin account kept getting locked out, after I had changed my password.. So I assumed I had used it somewhere to either run a service or a scheduled task on a test server. But where???
So I decided to write a little PowerShell script to help me find out where, and give me a chance to be more proactive next time I need to change my Password, or the password of one of our service accounts."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/posts/2010-09-08-my-account-keeps-getting-locked-out-where-did-i-use-it/><link rel=stylesheet href=/assets/style.css><link rel=stylesheet href=/assets/green.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/img/favicon/green.png><meta name=twitter:card content="summary"><meta name=twitter:site content><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="My account keeps getting locked out, where did I use it ?? :: XenoBlog"><meta property="og:description" content="A few weeks ago my admin account kept getting locked out, after I had changed my password.. So I assumed I had used it somewhere to either run a service or a scheduled task on a test server. But where???
So I decided to write a little PowerShell script to help me find out where, and give me a chance to be more proactive next time I need to change my Password, or the password of one of our service accounts."><meta property="og:url" content="/posts/2010-09-08-my-account-keeps-getting-locked-out-where-did-i-use-it/"><meta property="og:site_name" content="My account keeps getting locked out, where did I use it ??"><meta property="og:image" content="/img/favicon/green.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:section" content="Everyday"><meta property="article:published_time" content="2010-09-08 22:00:53 +0000 UTC"></head><body><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>XenoBlog</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=https://github.com/claustn>github</a></li><li><a href=https://xipher.dk/index.xml>RSS</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=https://github.com/claustn>github</a></li><li><a href=https://xipher.dk/index.xml>RSS</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=/posts/2010-09-08-my-account-keeps-getting-locked-out-where-did-i-use-it/>My account keeps getting locked out, where did I use it ??</a></h1><div class=post-meta><span class=post-date>2010-09-08</span></div><span class=post-tags>#<a href=/tags/powershell/>PowerShell</a>&nbsp;</span><div class=post-content><div><p>A few weeks ago my admin account kept getting locked out, after I had changed my password.. So I assumed I had used it somewhere to either run a service or a scheduled task on a test server. But where???</p><p>So I decided to write a little PowerShell script to help me find out where, and give me a chance to be more proactive next time I need to change my Password, or the password of one of our service accounts.</p><p>So I decided to try to write a script that connects to all our servers, and list all services running under domain credentials, and do the same for scheduled tasks. In our environment we have an issue with some COM+ objects that are either running as a domain admin user, or as &ldquo;interactive&rdquo; meaning that a domain admin user has to be logged into a machine at all times for the app to work.. (Yes I have yelled and screamed at the developers).</p><p>So what this script does, it connects info from domain machines, and puts it in a Excel spreadsheet.<br>In order to run the script, you need to have Powershell V2, Quest AD cmdlet (preferably ver. 1.2 or above) and permissions on the remote machines to connect via WMI.</p><p>[ps]<br>#==========================================================================</p><h1 id=name-getservicescheduledtaskandcomps1>NAME: GetServiceScheduledtaskandCom.ps1<a href=#name-getservicescheduledtaskandcomps1 class=hanchor arialabel=Anchor>&#8983;</a></h1><h1 id=heading><a href=#heading class=hanchor arialabel=Anchor>&#8983;</a></h1><h1 id=version-09>Version: 0.9<a href=#version-09 class=hanchor arialabel=Anchor>&#8983;</a></h1><h1 id=date-070910>Date: 07/09/10<a href=#date-070910 class=hanchor arialabel=Anchor>&#8983;</a></h1><h1 id=heading-1><a href=#heading-1 class=hanchor arialabel=Anchor>&#8983;</a></h1><h1 id=comment>COMMENT:<a href=#comment class=hanchor arialabel=Anchor>&#8983;</a></h1><h1 id=this-script-is-based-on-a-script-by-stephen-wheet-a-lot-of-the-code-has-been-rewritten-and>This script is based on a script by Stephen Wheet, a lot of the code has been rewritten, and<a href=#this-script-is-based-on-a-script-by-stephen-wheet-a-lot-of-the-code-has-been-rewritten-and class=hanchor arialabel=Anchor>&#8983;</a></h1><h1 id=and-a-bunch-of-code-has-been-added>and a bunch of code has been added.<a href=#and-a-bunch-of-code-has-been-added class=hanchor arialabel=Anchor>&#8983;</a></h1><h1 id=the-script-connects-to-remote-computers-and-lists-all-services-running-under-domain-accounts>The script connects to remote computers, and lists all services running under domain accounts,<a href=#the-script-connects-to-remote-computers-and-lists-all-services-running-under-domain-accounts class=hanchor arialabel=Anchor>&#8983;</a></h1><h1 id=it-does-the-same-for-scheduled-tasks-and-com-applications>it does the same for Scheduled Tasks and COM+ Applications.<a href=#it-does-the-same-for-scheduled-tasks-and-com-applications class=hanchor arialabel=Anchor>&#8983;</a></h1><h1 id=heading-2><a href=#heading-2 class=hanchor arialabel=Anchor>&#8983;</a></h1><h1 id=the-script-required-the-quest-ad-cmdlets-and-excel-installed-on-the-computer>The Script required the QUEST AD cmdlets and excel installed on the computer<a href=#the-script-required-the-quest-ad-cmdlets-and-excel-installed-on-the-computer class=hanchor arialabel=Anchor>&#8983;</a></h1><h1 id=heading-3><a href=#heading-3 class=hanchor arialabel=Anchor>&#8983;</a></h1><h1 id=missing-features-iis-app-pool-credentials-logged-in-users>Missing features: IIS APP Pool Credentials, Logged In Users<a href=#missing-features-iis-app-pool-credentials-logged-in-users class=hanchor arialabel=Anchor>&#8983;</a></h1><p>#==========================================================================<br>$domainname = (Get-QADRootDSE.Domain).Domain.ToString()</p><p>$searchroot = &ldquo;appension.local/&rdquo;</p><p>$ErrorActionPreference = &ldquo;SilentlyContinue&rdquo;</p><p>[System.Threading.Thread]::CurrentThread.CurrentCulture = &ldquo;en-US&rdquo;<br>$ErrorActionPreference = &ldquo;SilentlyContinue&rdquo;<br>$ExcelAPP = New-Object -comobject Excel.Application<br>$ExcelAPP.visible = $True</p><p>$ExcelWB = $ExcelAPP.Workbooks.Add()<br>$ServiceSheet = $ExcelWB.Worksheets.Item(1)<br>$ScheduledSheet = $ExcelWB.Worksheets.Item(2)<br>$COMPlusSheet = $ExcelWB.Worksheets.Item(3)</p><p>$ServiceSheet.Name = &ldquo;Services&rdquo;<br>$ScheduledSheet.Name = &ldquo;Scheduled Tasks&rdquo;<br>$COMPlusSheet.Name = &ldquo;COM+&rdquo;</p><h1 id=accounts-to-ignore>Accounts to ignore<a href=#accounts-to-ignore class=hanchor arialabel=Anchor>&#8983;</a></h1><p>$IgnoreAcct =<br>&ldquo;NT AUTHORITY\LOCAL SERVICE&rdquo;,<br>&ldquo;NT AUTHORITY\LOCALSERVICE&rdquo;,<br>&ldquo;LocalSystem&rdquo;,<br>&ldquo;.*",<br>&ldquo;NT AUTHORITY\NETWORK SERVICE&rdquo;,<br>&ldquo;NT AUTHORITY\NetworkService&rdquo;</p><p>$DefaultCOMObjects =<br>&lsquo;COM+ Utilities&rsquo;,<br>&lsquo;COM+ QC Dead Letter Queue Listener&rsquo;,<br>&lsquo;COM+ Explorer&rsquo;,<br>&lsquo;COM+ Utilities (32 bit)',<br>&lsquo;IIS Out-Of-Process Pooled Applications&rsquo;,<br>&lsquo;.NET Utilities&rsquo;</p><p>#Place Headers on out-put file</p><p>$ServiceSheet.Cells.Item(1,1) = &ldquo;Server&rdquo;<br>$ServiceSheet.Cells.Item(1,2) = &ldquo;Service&rdquo;<br>$ServiceSheet.Cells.Item(1,3) = &ldquo;Account&rdquo;</p><p>$ScheduledSheet.Cells.Item(1,1) = &ldquo;Server&rdquo;<br>$ScheduledSheet.Cells.Item(1,2) = &ldquo;Task&rdquo;<br>$ScheduledSheet.Cells.Item(1,3) = &ldquo;Next Run Time&rdquo;<br>$ScheduledSheet.Cells.Item(1,4) = &ldquo;Account&rdquo;</p><p>$COMPlusSheet.Cells.Item(1,1) = &ldquo;Server&rdquo;<br>$COMPlusSheet.Cells.Item(1,2) = &ldquo;COM+ Name&rdquo;<br>$COMPlusSheet.Cells.Item(1,3) = &ldquo;Identity&rdquo;</p><p>$d = $ServiceSheet.UsedRange<br>$d.Interior.ColorIndex = 19<br>$d.Font.ColorIndex = 11<br>$d.Font.Bold = $True</p><p>$l = $ScheduledSheet.UsedRange<br>$l.Interior.ColorIndex = 19<br>$l.Font.ColorIndex = 11<br>$l.Font.Bold = $True</p><p>$q = $COMPlusSheet.UsedRange<br>$q.Interior.ColorIndex = 19<br>$q.Font.ColorIndex = 11<br>$q.Font.Bold = $True</p><p>$intRowSer = 2<br>$intRowSch = 2<br>$intRowCom = 2</p><p>#Get all the servers from the specified OU<br>$Servers = get-QADComputer -SearchRoot $searchroot -OSName &ldquo;*Server*&rdquo; #| where {$_.name -like &ldquo;appo*"} # change the container based on site.</p><p>Foreach ($server in $Servers ) {<br>#$ErrorActionPreference = &ldquo;SilentlyContinue&rdquo;<br>$serverFQDN = $server.dnsname<br>#Test ping server to make sure it&rsquo;s up before querying it<br>if (Test-Connection $serverFQDN -Quiet -Count 1){<br>Write-Host &ldquo;<code>n ************* $serverFQDN Online </code>n&rdquo; -ForegroundColor Red<br>Write-Host &ldquo;****************** $($server.name) Services ******************&rdquo;</p><h1 id=get-service-info>Get service info<a href=#get-service-info class=hanchor arialabel=Anchor>&#8983;</a></h1><p>$error.clear()<br>$services = gwmi win32_service -computer $serverFQDN -property name, startname, caption |<br>% {</p><p>$name = $_.Caption<br>$Acctname = $_.StartName<br>If ( $IgnoreAcct -notcontains $Acctname )<br>{<br>Write-host &ldquo;$Name $Acctname&rdquo;<br>$ServiceSheet.Cells.Item($intRowSer, 1) = $serverFQDN<br>$ServiceSheet.Cells.Item($intRowSer, 2) = $name<br>$ServiceSheet.Cells.Item($intRowSer, 3) = $Acctname<br>$intRowSer++<br>} #end If</p><p>} #end ForEach</p><p>#Write log if no access<br>if (!$?) {<br>$ServiceSheet.Cells.Item($intRowSer, 1) = $serverFQDN<br>$ServiceSheet.Cells.item($intRowSer, 2).Interior.ColorIndex = 3<br>$ServiceSheet.Cells.Item($intRowSer, 2) = &ldquo;Access Denied/Offline&rdquo;<br>$ServiceSheet.Cells.Item($intRowSer, 3) = $Error<br>#$errmsg = &ldquo;$serverFQDN,No RPC server,ACCESS DENIED&rdquo;<br>Write-Host $Error<br>$intRowSer++<br>} # end Error</p><p>$schtask = Schtasks.exe /query /s $serverFQDN /V /FO CSV | ConvertFrom-Csv<br>Write-Host &ldquo;****************** $($server.name) Scheduled Tasks ******************&rdquo;<br>if ($schtask) {</p><p>Foreach ($sch in $schtask) {<br>#$Sch.&ldquo;Run As User&rdquo;<br>if ($Sch.&ldquo;Run As User&rdquo; -like &ldquo;$($domainname)*") {<br>Write-Host $serverFQDN ($Sch.TaskName).replace("","") $Sch.&lsquo;Run As User&rsquo;</p><p>$ScheduledSheet.Cells.Item($intRowSch,1) = $serverFQDN<br>$ScheduledSheet.Cells.Item($intRowSch,2) = ($sch.TaskName).replace('','')<br>$ScheduledSheet.Cells.Item($intRowSch,3) = $Sch.&lsquo;Next Run Time&rsquo;<br>$ScheduledSheet.Cells.Item($intRowSch,4) = $sch.&lsquo;Run As User&rsquo;<br>$intRowSch++</p><p>}</p><p>}<br>}<br>Write-Host &ldquo;****************** $($server.name) COM+ Applications ******************&rdquo;<br>#$targetComputer = $serverFQDN<br>$comAdmin = New-Object -comobject COMAdmin.COMAdminCatalog<br>$comAdmin.Connect($serverFQDN)<br>$apps = $comAdmin.GetCollection(&ldquo;Applications&rdquo;)</p><p>$apps.Populate()</p><p>foreach ($app in $apps) {<br>If ( $IgnoreAcct -notcontains ($app.Value(&ldquo;Identity&rdquo;)) -and ( $DefaultCOMObjects -notcontains ($app.Value(&ldquo;Name&rdquo;)) )) {<br>$q.Cells.Item($intRowCom,1) = $serverFQDN<br>$q.Cells.Item($intRowCom,2) = $app.Value(&ldquo;Name&rdquo;)<br>$q.Cells.Item($intRowCom,3) = $app.Value(&ldquo;Identity&rdquo;)<br>Write-Host $app.Value(&ldquo;Name&rdquo;) $app.Value(&ldquo;Identity&rdquo;)<br>$intRowCom++<br>}<br>}<br>}</p><p>Else<br>{<br>Write-Host &ldquo;$serverFQDN ************* OFFLINE&rdquo;<br>} #end Else<br>}<br>#end ForEach<br>$d.EntireColumn.AutoFit()<br>$l.EntireColumn.AutoFit()<br>$q.EntireColumn.AutoFit()<br>[/ps]</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=/posts/2010-09-08-account-lockout-continued/><span class=button__icon>←</span>
<span class=button__text>Account lockout continued</span></a></span>
<span class="button next"><a href=/posts/2010-05-30-export-xls-powershell-script-to-export-to-xls/><span class=button__text>Export-xls Powershell script to export to XLS</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2020 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=/assets/main.js></script><script src=/assets/prism.js></script></div></body></html>