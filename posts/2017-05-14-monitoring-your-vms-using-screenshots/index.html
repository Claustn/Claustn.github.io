<!doctype html><html lang=en><head><title>Monitoring your VM's using screenshots :: XenoBlog — Random rants</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="(This is part 1 of 3, in an articles series on how we at Unity started using &amp;ldquo;screenshots&amp;rdquo; and machine learning in our monitoring system)
Part 1: Getting screenshots from VMware machines (This Post)
Part 2: Using image analysis to detect machines in a broken state (Not published yet)
Part 3: Using Clarifai &amp;ldquo;Machine learning&amp;rdquo; to further narrow down our results (Not Published yet)
In my new job as a &amp;ldquo;DevOps&amp;rdquo; engineer (I know I know, there is no such thing as a DevOps engineer), I am working with Unity&amp;rsquo;s build farm, we are building the Unity engine, and a lots of artifacts 1000&amp;rsquo;s of times a day, so our build farm is relatively big, running multiple different OS&amp;rsquo;s like Windows, Mac and Linux."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/posts/2017-05-14-monitoring-your-vms-using-screenshots/><link rel=stylesheet href=/assets/style.css><link rel=stylesheet href=/assets/green.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/img/favicon/green.png><meta name=twitter:card content="summary"><meta name=twitter:site content><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Monitoring your VM's using screenshots :: XenoBlog"><meta property="og:description" content="(This is part 1 of 3, in an articles series on how we at Unity started using &amp;ldquo;screenshots&amp;rdquo; and machine learning in our monitoring system)
Part 1: Getting screenshots from VMware machines (This Post)
Part 2: Using image analysis to detect machines in a broken state (Not published yet)
Part 3: Using Clarifai &amp;ldquo;Machine learning&amp;rdquo; to further narrow down our results (Not Published yet)
In my new job as a &amp;ldquo;DevOps&amp;rdquo; engineer (I know I know, there is no such thing as a DevOps engineer), I am working with Unity&amp;rsquo;s build farm, we are building the Unity engine, and a lots of artifacts 1000&amp;rsquo;s of times a day, so our build farm is relatively big, running multiple different OS&amp;rsquo;s like Windows, Mac and Linux."><meta property="og:url" content="/posts/2017-05-14-monitoring-your-vms-using-screenshots/"><meta property="og:site_name" content="Monitoring your VM's using screenshots"><meta property="og:image" content="/img/favicon/green.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:section" content="Everyday"><meta property="article:published_time" content="2017-05-14 23:33:03 +0000 UTC"></head><body><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>XenoBlog</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=https://github.com/claustn>github</a></li><li><a href=https://xipher.dk/index.xml>RSS</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=https://github.com/claustn>github</a></li><li><a href=https://xipher.dk/index.xml>RSS</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=/posts/2017-05-14-monitoring-your-vms-using-screenshots/>Monitoring your VM&rsquo;s using screenshots</a></h1><div class=post-meta><span class=post-date>2017-05-14</span></div><div class=post-content><div><p>(This is part 1 of 3, in an articles series on how we at Unity started using &ldquo;screenshots&rdquo; and machine learning in our monitoring system)</p><p>Part 1: Getting screenshots from VMware machines (This Post)<br>Part 2: Using image analysis to detect machines in a broken state (Not published yet)<br>Part 3: Using Clarifai &ldquo;Machine learning&rdquo; to further narrow down our results (Not Published yet)</p><p>In my new job as a &ldquo;DevOps&rdquo; engineer (I know I know, there is no such thing as a DevOps engineer), I am working with Unity&rsquo;s build farm, we are building the Unity engine, and a lots of artifacts 1000&rsquo;s of times a day, so our build farm is relatively big, running multiple different OS&rsquo;s like Windows, Mac and Linux.</p><p>We are continuously trying to improve our monitoring of the platform, both in order to detect failed machines, but also trying to gather information as to what have gone wrong, so we can use this information to prevent the same issues arising in the future, by giving feedback to the relecant teams.</p><p>We had a period, where we had some storage related issues, this caused Mac and Linux machines, in particular, to crash and hang, we had no trouble detecting the machines went offline, but since we weren&rsquo;t able to connect to these machines, we could not tell what &ldquo;state&rdquo; they were in. So in order to document, what had happened, we had to look at the console of the given machine.<br>So I started thinking if there was an automated way that I could test for this, and it hit me, that I had read somewhere, that it I possible in Vmware to take a &ldquo;screenshot&rdquo; of a running machine.</p><p>So I wrote a PowerShell script that would take a screenshot of all our running VM&rsquo;s in our build farm, then at least I had some documentation of what the &ldquo;state&rdquo; of the machines were.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e># This script &#39;takes&#39; a screenshot of all running VMs, and outputs a jpeg file to a local folder (C:\Temp\VMImages) </span>
<span style=color:#75715e># This script requires a credential object called $cred # In this case I am reading it from a file, in order to make an encrypted file containing username and password you can do </span>
<span style=color:#75715e># $Cred = Get-Credential </span>
<span style=color:#75715e># $Cred | Export-CliXML C:\what\ever.xml </span>
<span style=color:#75715e># This password is then encrypted by Windows DPAPI, which means it can only be decrypted on the machines it was encrypted on, by the user who encrypted it. </span>
<span style=color:#75715e># It also requires the modules VMware.VimAutomation.Core, SplitPipeline. </span>
<span style=color:#75715e># Example installing module from PowerShell Gallery:</span>
<span style=color:#e6db74>&#39;Install-Module SplitPipeline&#39;</span>
Import-Module -Name <span style=color:#e6db74>&#39;VMware.VimAutomation.Core&#39;</span> -ErrorAction Stop
Import-Module -Name <span style=color:#e6db74>&#39;SplitPipeline&#39;</span> -ErrorAction Stop
$Null = Set-PowerCLIConfiguration -WebOperationTimeoutSeconds 10 -Scope Session -Confirm<span style=color:#960050;background-color:#1e0010>:</span>$false
$Null = Set-PowerCLIConfiguration -InvalidCertificateAction Ignore -Scope Session -Confirm<span style=color:#960050;background-color:#1e0010>:</span>$false
$Vcenter = <span style=color:#e6db74>&#39;MyVcenterServer&#39;</span>
<span style=color:#75715e>#Get Credentials that allow me to connect to Vcenter </span>
$cred = (Import-Clixml -Path <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>$</span><span style=color:#e6db74>PSScriptRoot\Credentials\script-svc.xml</span><span style=color:#e6db74>&#34;</span>) 
Connect-VIServer -Server $Vcenter -Credential $cred 
<span style=color:#75715e>#Get a list of all VM&#39;s </span>
$VMs = Get-VM 
<span style=color:#75715e>#Create a websession that I can reuse to connect to Vcenter </span>
$Null = Invoke-WebRequest -Uri https<span style=color:#960050;background-color:#1e0010>:</span>//$Vcenter/rest/com/vmware/cis/session -Method Post -Credential $cred -SessionVariable session 
<span style=color:#75715e>#Remove all images from previous runs </span>
Get-ChildItem -Filter \*.jpg -Path C:\temp\VMImages | Remove-Item
  
$VMs | Split-Pipeline -Variable cred, session -Count 2 -Begin {
  $ProgressPreference = <span style=color:#e6db74>&#39;SilentlyContinue&#39;</span> 
} -Script {
  <span style=color:#66d9ef>Process</span> {$MOID = ($_ | Select-Object -ExpandProperty id).Replace(<span style=color:#e6db74>&#39;VirtualMachine-&#39;</span>,<span style=color:#e6db74>&#39;&#39;</span>)
    $ServerName = $_.Name 
    <span style=color:#66d9ef>if</span> ($MOID <span style=color:#f92672>-AND</span> ($_.PowerState <span style=color:#f92672>-eq</span> <span style=color:#e6db74>&#39;PoweredOn&#39;</span>)) 
    {
      <span style=color:#66d9ef>Try</span> 
      { 
        <span style=color:#75715e>#Use invoke-webrequest to get an image 1024\*768 pixels </span>
        Invoke-WebRequest -Uri <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>https://</span><span style=color:#e6db74>$</span><span style=color:#e6db74>Vcenter/screen?id=</span><span style=color:#e6db74>$</span><span style=color:#e6db74>MOID&amp;w=1024&amp;h=768</span><span style=color:#e6db74>&#34;</span> -OutFile <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>C:\temp\VMImages\</span>$($_.Name)<span style=color:#e6db74>.jpg</span><span style=color:#e6db74>&#34;</span> -WebSession $session -TimeoutSec 20 -ErrorAction Stop
      }
      <span style=color:#66d9ef>Catch</span> 
      {
        Write-Warning -Message <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Failed to ScreenShot: </span><span style=color:#e6db74>$</span><span style=color:#e6db74>ServerName, MOID:</span><span style=color:#e6db74>$</span><span style=color:#e6db74>MOID</span><span style=color:#e6db74>&#34;</span> 
      }
    }
  }
}
</code></pre></div><p>In the above example am creating a &ldquo;session&rdquo; to reuse for the calls against Vcenter, so we will not see 100&rsquo;s of connections in Vcenter.</p><p>In the next part of the article, I will cover some PowerShell functions I wrote to wrap ImageMagick to make some initial comparisons of each screenshot, sorting them in known good, known bad and What the h**l is going on here ;)</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=/posts/2017-06-10-active-directory-users-password-report/><span class=button__icon>←</span>
<span class=button__text>Active Directory Users Password Report</span></a></span>
<span class="button next"><a href=/posts/2016-06-09-regex-callback/><span class=button__text>Regex CallBack</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2020 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=/assets/main.js></script><script src=/assets/prism.js></script></div></body></html>