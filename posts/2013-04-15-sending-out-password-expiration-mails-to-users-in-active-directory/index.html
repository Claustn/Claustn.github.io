<!doctype html><html lang=en><head><title>Sending out Password Expiration mails to users in Active Directory :: XenoBlog — Random rants</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="I was tasked with writing a script that would send out an e-mail to users, when there were 14,7,3,2 and 1 days before their AD passwords expired.
I use the Quest AD cmdlets to get users from AD.
if (!(Get-PSSnapin Quest.ActiveRoles.ADManagement -ErrorAction SilentlyContinue)) { Add-PSSnapin Quest.ActiveRoles.ADManagement } $mailfrom = &amp;quot;IT@XXXXXX.DK&amp;quot; $smtpsrv = &amp;quot;MailServerName&amp;quot; #Getting the Default maximum password age from AD $MaxPassAge = (Get-QADObject (Get-QADRootDSE).defaultNamingContextDN).MaximumPasswordAge.days #Getting a list of AD users, who's password doesn't expire, and adding a calculated value, with the amount of days till the password expires."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/posts/2013-04-15-sending-out-password-expiration-mails-to-users-in-active-directory/><link rel=stylesheet href=/assets/style.css><link rel=stylesheet href=/assets/green.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/img/favicon/green.png><meta name=twitter:card content="summary"><meta name=twitter:site content><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Sending out Password Expiration mails to users in Active Directory :: XenoBlog"><meta property="og:description" content="I was tasked with writing a script that would send out an e-mail to users, when there were 14,7,3,2 and 1 days before their AD passwords expired.
I use the Quest AD cmdlets to get users from AD.
if (!(Get-PSSnapin Quest.ActiveRoles.ADManagement -ErrorAction SilentlyContinue)) { Add-PSSnapin Quest.ActiveRoles.ADManagement } $mailfrom = &amp;quot;IT@XXXXXX.DK&amp;quot; $smtpsrv = &amp;quot;MailServerName&amp;quot; #Getting the Default maximum password age from AD $MaxPassAge = (Get-QADObject (Get-QADRootDSE).defaultNamingContextDN).MaximumPasswordAge.days #Getting a list of AD users, who's password doesn't expire, and adding a calculated value, with the amount of days till the password expires."><meta property="og:url" content="/posts/2013-04-15-sending-out-password-expiration-mails-to-users-in-active-directory/"><meta property="og:site_name" content="Sending out Password Expiration mails to users in Active Directory"><meta property="og:image" content="/img/favicon/green.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:section" content="Everyday"><meta property="article:published_time" content="2013-04-15 09:21:50 +0000 UTC"></head><body><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>XenoBlog</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About</a></li><li><a href=https://github.com/claustn>github</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About</a></li><li><a href=https://github.com/claustn>github</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=/posts/2013-04-15-sending-out-password-expiration-mails-to-users-in-active-directory/>Sending out Password Expiration mails to users in Active Directory</a></h1><div class=post-meta><span class=post-date>2013-04-15</span></div><div class=post-content><div><p>I was tasked with writing a script that would send out an e-mail to users, when there were 14,7,3,2 and 1 days before their AD passwords expired.</p><p>I use the Quest AD cmdlets to get users from AD.</p><pre><code>if (!(Get-PSSnapin Quest.ActiveRoles.ADManagement -ErrorAction SilentlyContinue)) { Add-PSSnapin Quest.ActiveRoles.ADManagement } $mailfrom = &quot;IT@XXXXXX.DK&quot; $smtpsrv = &quot;MailServerName&quot; #Getting the Default maximum password age from AD $MaxPassAge = (Get-QADObject (Get-QADRootDSE).defaultNamingContextDN).MaximumPasswordAge.days #Getting a list of AD users, who's password doesn't expire, and adding a calculated value, with the amount of days till the password expires. [Array]$users = Get-QADUser -Enabled -PasswordNeverExpires:$false -SizeLimit 0 -Email \* |Select-Object Name,Email,@{Name=&quot;Expires&quot;;Expression={ $MaxPassAge - $\_.PasswordAge.days }} #Here-String containing the HTML to format the body of the e-mail Text is in Danish :) $html = @&quot; \&lt;html\&gt;\&lt;head\&gt;\&lt;style type=&quot;text/css&quot;\&gt;body { font-family: Arial, Helvetica, sans-serif; font-size: 9pt; } \&lt;/style\&gt;\&lt;/head\&gt;\&lt;body\&gt;\&lt;p\&gt;Dit Password til Windows, Outlook, Citrix og Mobil Sync på Iphone er ved at udløbe.\&lt;br\&gt;\&lt;br\&gt; \&lt;strong\&gt;Dage til udløb: \&lt;/strong\&gt; \&lt;strong\&gt;\&lt;font color=&quot;red&quot;\&gt;DAYS\&lt;/font\&gt;\&lt;/strong\&gt;\&lt;br\&gt;\&lt;br\&gt;Når du skal skifte dit password, skal du overholde følgende kompleksitetsregler:\&lt;/p\&gt; \&lt;ul\&gt;\&lt;li\&gt;Passwordet skal minimum være på 8 karakterer.\&lt;/li\&gt;\&lt;li\&gt;Passwordet skal minimum indeholde ét &quot;stort&quot; bogstav.\&lt;/li\&gt;\&lt;li\&gt;Passwordet skal minimum indeholde ét tal\&lt;/li\&gt;\&lt;li\&gt;Det må ikke være et password, der er brugt, inden for de sidste 20 password skift.\&lt;/li\&gt;\&lt;li\&gt;Passwordet må ikke indeholde dele af dit navn, efternavn og email adresse.\&lt;/li\&gt;\&lt;/ul\&gt; \&lt;p\&gt;For at ændre password, trykker du CTRL+ALT+DELETE og vælger &quot;Skift Adgangskode...&quot;\&lt;/p\&gt; \&lt;img src=&quot;\\Path\To\PictureFile\Signature.jpg&quot; alt=&quot;Signature&quot; align =&quot;left&quot; /\&gt; \&lt;/body\&gt;\&lt;/html\&gt; &quot;@ Foreach ($user in $users) { $name = $user.name $pwdAge = $user.Expires Switch ($pwdAge) { 14 { $body = $html.replace(&quot;DAYS&quot;, &quot;14&quot;) $subject = &quot;Dit Password udløber om 14 dage&quot; Send-MailMessage -To $user.Email -From $mailfrom -Subject $subject -Body $body -SmtpServer $smtpsrv -BodyAsHtml -Encoding ([System.Text.Encoding]::UTF7) write-eventlog -logname &quot;Powershell Scripts&quot; -source &quot;PSScripts&quot; -eventID 111 -entrytype Information -message &quot;Password for $name will expire in 14 days&quot; } 7 { $body = $html.replace(&quot;DAYS&quot;, &quot;7&quot;) $subject = &quot;Dit Password udløber om 7 dage&quot; Send-MailMessage -To $user.Email -From $mailfrom -Subject $subject -Body $body -SmtpServer $smtpsrv -BodyAsHtml -Encoding ([System.Text.Encoding]::UTF7) write-eventlog -logname &quot;Powershell Scripts&quot; -source &quot;PSScripts&quot; -eventID 111 -entrytype Information -message &quot;Password for $name will expire in 7 days&quot; } 3 { $body = $html.replace(&quot;DAYS&quot;, &quot;3&quot;) $subject = &quot;Dit Password udløber om 3 dage&quot; Send-MailMessage -To $user.Email -From $mailfrom -Subject $subject -Body $body -SmtpServer $smtpsrv BodyAsHtml -Encoding ([System.Text.Encoding]::UTF7) write-eventlog -logname &quot;Powershell Scripts&quot; -source &quot;PSScripts&quot; -eventID 111 -entrytype Information -message &quot;Password for $name will expire in 3 days&quot; } 2 { $body = $html.replace(&quot;DAYS&quot;, &quot;2&quot;) $subject = &quot;Dit Password udløber om 2 dage&quot; Send-MailMessage -To $user.Email -From $mailfrom -Subject $subject -Body $body -SmtpServer $smtpsrv -BodyAsHtml -Encoding ([System.Text.Encoding]::UTF7) write-eventlog -logname &quot;Powershell Scripts&quot; -source &quot;PSScripts&quot; -eventID 111 -entrytype Information -message &quot;Password for $name will expire in 2 days&quot; } 1 { $body = $html.replace(&quot;DAYS&quot;, &quot;1&quot;) $subject = &quot;Dit Password udløber om 1 dage&quot; Send-MailMessage -To $user.Email -From $mailfrom -Subject $subject -Body $body -SmtpServer $smtpsrv -BodyAsHtml -Encoding ([System.Text.Encoding]::UTF7) write-eventlog -logname &quot;Powershell Scripts&quot; -source &quot;PSScripts&quot; -eventID 111 -entrytype Information -message &quot;Password for $name will expire in 1 day&quot; } 0 { $body = $html.replace(&quot;DAYS&quot;, &quot;0&quot;) $subject = &quot;Dit Password udløber idag!!!&quot; Send-MailMessage -To $user.Email -From $mailfrom -Subject $subject -Body $body -SmtpServer $smtpsrv -BodyAsHtml -Encoding ([System.Text.Encoding]::UTF7) write-eventlog -logname &quot;Powershell Scripts&quot; -source &quot;PSScripts&quot; -eventID 111 -entrytype Information -message &quot;Password for $name will expire today!!!&quot; } } }
</code></pre></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=/posts/2013-06-27-culture-gotchas/><span class=button__icon>←</span>
<span class=button__text>Culture Gotchas</span></a></span>
<span class="button next"><a href=/posts/2012-09-10-troubleshooting-test-connection/><span class=button__text>Troubleshooting Test-Connection</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2020 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=/assets/main.js></script><script src=/assets/prism.js></script></div></body></html>