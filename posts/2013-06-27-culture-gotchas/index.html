<!doctype html><html lang=en><head><title>Culture Gotchas :: XenoBlog — Random rants</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="We are not everyone running Powershell on machines with ”en-US” locale, and sometimes that gives some unexpected problems, if you are running on a non US system, and have been working with Excel for instance, you have probably run into this error when trying to add something to Excel like this:
$xl= New-Object -COM Excel.Application
$xl.Visible = $true
$wb=$xl.Workbooks.Add()

I stumbled upon another culture “gotcha” when trying to get some eventlog info using (Wasn’t obvious to me at the time it was a Culture issue)"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/posts/2013-06-27-culture-gotchas/><link rel=stylesheet href=/assets/style.css><link rel=stylesheet href=/assets/green.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/img/favicon/green.png><meta name=twitter:card content="summary"><meta name=twitter:site content><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Culture Gotchas :: XenoBlog"><meta property="og:description" content="We are not everyone running Powershell on machines with ”en-US” locale, and sometimes that gives some unexpected problems, if you are running on a non US system, and have been working with Excel for instance, you have probably run into this error when trying to add something to Excel like this:
$xl= New-Object -COM Excel.Application
$xl.Visible = $true
$wb=$xl.Workbooks.Add()

I stumbled upon another culture “gotcha” when trying to get some eventlog info using (Wasn’t obvious to me at the time it was a Culture issue)"><meta property="og:url" content="/posts/2013-06-27-culture-gotchas/"><meta property="og:site_name" content="Culture Gotchas"><meta property="og:image" content="/img/favicon/green.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:section" content="Everyday"><meta property="article:published_time" content="2013-06-27 10:37:35 +0000 UTC"></head><body><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>XenoBlog</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=https://github.com/claustn>github</a></li><li><a href=/index.xml>RSS</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=https://github.com/claustn>github</a></li><li><a href=/index.xml>RSS</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=/posts/2013-06-27-culture-gotchas/>Culture Gotchas</a></h1><div class=post-meta><span class=post-date>2013-06-27</span></div><div class=post-content><div><p>We are not everyone running Powershell on machines with ”en-US” locale, and sometimes that gives some unexpected problems, if you are running on a non US system, and have been working with Excel for instance, you have probably run into this error when trying to add something to Excel like this:</p><p>$xl= New-Object -COM Excel.Application</p><p>$xl.Visible = $true</p><p>$wb=$xl.Workbooks.Add()</p><p><a href=http://www.xipher.dk/WordPress/wp-content/uploads/clip_image002.jpg><img src=/assets/images/clip_image002_thumb.jpg alt=clip_image002 title=clip_image002></a></p><p>I stumbled upon another culture “gotcha” when trying to get some eventlog info using (Wasn’t obvious to me at the time it was a Culture issue)</p><p>$daysBack = (Get-Date).Adddays(-2)</p><p>Get-WinEvent -ComputerName Localhost -FilterHashTable @{LogName='Application&rsquo;; StartTime=$daysBack; ID=8224}</p><p><a href=http://www.xipher.dk/WordPress/wp-content/uploads/clip_image004.jpg><img src=/assets/images/clip_image004_thumb.jpg alt=clip_image004 title=clip_image004></a></p><p>When I ran it I would get basic information back, just not the contents of the “Message” property, which in this case I very relevant.</p><p>I tried running both commands on a test server, where both command worked without any problems. Since the server culture was set to ”en-US” that led me to dig a little deeper into the culture settings.</p><p>First thing I tried was to set the culture manually:</p><p><a href=:CurrentThread.CurrentCulture>System.Threading.Thread</a>::CurrentThread.CurrentCulture = &ldquo;en-US&rdquo;</p><p>Then check to see if the culture was changed.</p><p><a href=http://www.xipher.dk/WordPress/wp-content/uploads/clip_image006.jpg><img src=/assets/images/clip_image006_thumb.jpg alt=clip_image006 title=clip_image006></a></p><p>To my surprise my culture was still da-DK, my initial thought was that PowerShell in v2 is default is running in MTA mode (Multi Threaded Apartment), meaning that my culture query might have been executed by a different thread. I tried to set the CurrentCulture to ”en-US” 100 times, but still every time I queried CurrentCulture I would get ”da-DK” back. (PowerShell v3 is running in STA (Single Threaded Apartment) mode per default)</p><p>Next I tried was to wrap it in a ScriptBlock</p><p>& {<a href=:CurrentThread.CurrentCulture>System.Threading.Thread</a>::CurrentThread.CurrentCulture = &ldquo;en-US&rdquo;</p><p><a href=:CurrentThread.CurrentCulture>System.Threading.Thread</a>::CurrentThread.CurrentCulture }</p><p><a href=http://www.xipher.dk/WordPress/wp-content/uploads/clip_image008.jpg><img src=/assets/images/clip_image008_thumb.jpg alt=clip_image008 title=clip_image008></a><br>Which worked, and returned ”en-US” as CurrentCulture</p><p>I then tried wrapping it in a function</p><p>Function Test {<a href=:CurrentThread.CurrentCulture>System.Threading.Thread</a>::CurrentThread.CurrentCulture = &ldquo;en-US&rdquo;</p><p><a href=:CurrentThread.CurrentCulture>System.Threading.Thread</a>::CurrentThread.CurrentCulture }</p><p><a href=http://www.xipher.dk/WordPress/wp-content/uploads/clip_image010.jpg><img src=/assets/images/clip_image010_thumb.jpg alt=clip_image010 title=clip_image010></a><br>Which also gave me the Expected ”en-US” Culture.</p><p>After conferring with Joel Bennet, this led is to believe that the CurrentCulture is being reset after every pipeline.</p><p>We then tried (on a single line)</p><p><a href=:CurrentThread.CurrentCulture>System.Threading.Thread</a>::CurrentThread.CurrentCulture = &ldquo;en-US&rdquo;;<a href=:CurrentThread.CurrentCulture>System.Threading.Thread</a>::CurrentThread.CurrentCulture</p><p><a href=http://www.xipher.dk/WordPress/wp-content/uploads/clip_image012.jpg><img src=/assets/images/clip_image012_thumb.jpg alt=clip_image012 title=clip_image012></a></p><p>Which confirmed that the culture change is only “active” in the current pipeline.</p><p>I found this strange and wrote to the PowerShell team at Microsoft to have them shed some light on why this was happening.</p><p>Lee Holmes replied:</p><p>“PowerShell saves and restores the thread’s current culture before and after invoking a pipeline so that scripts don’t trash your entire session. When you invoke the command to set the culture, it impacts the entire pipeline – but then we restore it when the pipeline completes. When you put the two commands in the same pipeline, our culture restoration code hasn’t kicked in yet and thus you get to see what the pipeline’s culture was changed to”</p><p>So remember if you are trying to run a script that requires a different Culture setting, that it gets reset after each pipeline completes.</p><p>Last thing we tried was to see if PowerShell was using $PSCulture to reset the Culture settings, so I tried changing $PSCulture to “en-US” instead of “da-DK” (It is a “read-only” variable, so you have to use –Force)</p><p>Set-Variable PSCulture -Value en-US -Force</p><p><a href=http://www.xipher.dk/WordPress/wp-content/uploads/clip_image014.jpg><img src=/assets/images/clip_image014_thumb.jpg alt=clip_image014 title=clip_image014></a></p><p>But to no avail, it seems as if PowerShell checking the system culture, and not something defined within the PowerShell session.</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=/posts/2013-08-02-managing-queue-it-queues-with-powershell/><span class=button__icon>←</span>
<span class=button__text>Managing Queue-It queues with PowerShell</span></a></span>
<span class="button next"><a href=/posts/2013-04-15-sending-out-password-expiration-mails-to-users-in-active-directory/><span class=button__text>Sending out Password Expiration mails to users in Active Directory</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2020 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=/assets/main.js></script><script src=/assets/prism.js></script></div></body></html>