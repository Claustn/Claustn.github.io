<!doctype html><html lang=en><head><title>Loading "P0wned" password file into SQLite :: XenoBlog — Random rants</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="Recently I had a discussion with a friend of mine with regards to checking AD passwords against the &amp;ldquo;P0wned password list&amp;rdquo; released by Troy Hunt.
So I went and downloaded the the file from here
That turned out to be a 8.8 GB Zip file, that unpacked to almost 19GB of raw text. (The file consists of to columns of data the NTHash and the number of occurrences across password leaks."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/posts/2018-09-23-loading-p0wned-password-files-into-sqlite/><link rel=stylesheet href=/assets/style.css><link rel=stylesheet href=/assets/green.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/img/favicon/green.png><meta name=twitter:card content="summary"><meta name=twitter:site content><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Loading &#34;P0wned&#34; password file into SQLite :: XenoBlog"><meta property="og:description" content="Recently I had a discussion with a friend of mine with regards to checking AD passwords against the &amp;ldquo;P0wned password list&amp;rdquo; released by Troy Hunt.
So I went and downloaded the the file from here
That turned out to be a 8.8 GB Zip file, that unpacked to almost 19GB of raw text. (The file consists of to columns of data the NTHash and the number of occurrences across password leaks."><meta property="og:url" content="/posts/2018-09-23-loading-p0wned-password-files-into-sqlite/"><meta property="og:site_name" content="Loading &#34;P0wned&#34; password file into SQLite"><meta property="og:image" content="/img/favicon/green.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:section" content="Everyday"><meta property="article:published_time" content="2018-09-23 12:58:34 +0000 UTC"></head><body><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>XenoBlog</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=https://github.com/claustn>github</a></li><li><a href=/index.xml>RSS</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=https://github.com/claustn>github</a></li><li><a href=/index.xml>RSS</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=/posts/2018-09-23-loading-p0wned-password-files-into-sqlite/>Loading &ldquo;P0wned&rdquo; password file into SQLite</a></h1><div class=post-meta><span class=post-date>2018-09-23</span></div><div class=post-content><div><p>Recently I had a discussion with a friend of mine with regards to checking AD passwords against the &ldquo;P0wned password list&rdquo; released by Troy Hunt.</p><p>So I went and downloaded the the file from <a href=https://haveibeenpwned.com/Passwords>here</a></p><p>That turned out to be a 8.8 GB Zip file, that unpacked to almost 19GB of raw text. (The file consists of to columns of data the NTHash and the number of occurrences across password leaks.)</p><p>Having to look through 19 GB of unsorted data I knew would be very slow, but I decided to test out different approaches. Keeping in mind, that I wanted to integrate this with my previously released AD Password checker tool <a href=https://github.com/Claustn/Password-Report>here</a> , and the test data I have in AD consists of about 500 Users with the last 20 passwords stored in HashHistory, meaning that I would have to do about 10.000 lookups into the file.</p><hr><p>First attempt was simply to use Select-String and look for a NTHash value, even on a very fast Nvme drive this took more than 2 minutes per query, meaning it would take 20.000 minutes + (14 days)</p><hr><p>I then tried Grep and Sift which yielded results in the same 2 minute area as Select-String.</p><hr><p>Since I already had all the AD data in a SQLite database, I thought I would try to load the data into the DB. So I loaded the data into the DB and tried to query the DB for a specific Hash, this was a little bit faster than the plain file, but still took 1.40 minutes. Then I considered adding an index to the NTHash column, but since that has almost 520 million rows, and takes up 99% of the space used, it would mean that the DB would be double the size (around 40GB), which I felt would make it less portable.</p><hr><p>I really wanted to be able to keep everything in a way, so this could be run without &ldquo;installing&rdquo; anything and keeping it portable. So loading the database into MySQL really was not an option either. So I started reading the SQLite documentation and realized that it supports  Clustered indexed. Meaning that I could omit the default index and have SQLite use the NTHash data as an index. This means that the import time into the DB will go up (Takes about 3½ -4 hours),  because the data has to be sorted in order for it to act as an index. Since this data is very static the cost of using NTHash as an index is very low. With the data indexed the query time has gone done to about 10ms, which is very acceptable.</p><hr><h2 id=import-data>Import Data<a href=#import-data class=hanchor arialabel=Anchor>&#8983;</a></h2><p>First off we need to create the table, and tell SQLite not to use it &ldquo;regular&rdquo; index,  by telling it not to add a RowID, but use a &ldquo;clustered index&rdquo;.</p><pre><code>CREATE TABLE p0wned (
	NTHash	TEXT,
	cnt	INTEGER,
	PRIMARY KEY(NTHash)
) WITHOUT ROWID;
</code></pre><p>Then we need to set the right import settings.</p><pre><code>.mode csv
.separator :
.import &quot;C:/temp/dbtest/pwds.txt&quot; p0wned
</code></pre><p>This can of course also be automated, we can create a sql.txt file and put this into it.</p><pre><code>CREATE TABLE p0wned (
	NTHash	TEXT,
	cnt	INTEGER,
	PRIMARY KEY(NTHash)
) WITHOUT ROWID;
.mode csv
.separator :
.import &quot;C:/temp/dbtest/pwds.txt&quot; p0wned
</code></pre><p>And run (This does require the sqlite3 binary)</p><pre><code>Get-Content .\sql.txt | &amp; sqlite3 test1.db
</code></pre><p>This has given us an ultra fast way to lookup data in the &ldquo;Have I been p0wned&rdquo; database, and all can be run locally.</p><p>Next up I will show you how I have used that in my AD Password report script, to tell if users are using password that are in the &ldquo;Have I been P0wned&rdquo; list, or if you have users who are particular bad at passwords.</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=/posts/2017-06-10-active-directory-users-password-report/><span class=button__text>Active Directory Users Password Report</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2020 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=/assets/main.js></script><script src=/assets/prism.js></script></div></body></html>